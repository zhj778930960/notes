<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>控制器Controller | 相得益张</title>
    <meta name="generator" content="VuePress 1.4.1">
    <link rel="shortcut icon" href="./favicon.ico">
    <meta name="description" content="相得益张--学习记录">
    <link rel="preload" href="/notes/assets/css/0.styles.42e4205b.css" as="style"><link rel="preload" href="/notes/assets/js/app.21629e5a.js" as="script"><link rel="preload" href="/notes/assets/js/2.270ffd18.js" as="script"><link rel="preload" href="/notes/assets/js/12.34958283.js" as="script"><link rel="prefetch" href="/notes/assets/js/10.1f32d64b.js"><link rel="prefetch" href="/notes/assets/js/11.7cb90fa6.js"><link rel="prefetch" href="/notes/assets/js/13.9715496c.js"><link rel="prefetch" href="/notes/assets/js/14.aa63cb49.js"><link rel="prefetch" href="/notes/assets/js/15.429d9621.js"><link rel="prefetch" href="/notes/assets/js/16.ea154458.js"><link rel="prefetch" href="/notes/assets/js/17.09d01add.js"><link rel="prefetch" href="/notes/assets/js/18.97082561.js"><link rel="prefetch" href="/notes/assets/js/19.f069562d.js"><link rel="prefetch" href="/notes/assets/js/20.571417a6.js"><link rel="prefetch" href="/notes/assets/js/21.61e64d96.js"><link rel="prefetch" href="/notes/assets/js/22.bf3f207e.js"><link rel="prefetch" href="/notes/assets/js/23.1a36a20c.js"><link rel="prefetch" href="/notes/assets/js/24.7b1398e4.js"><link rel="prefetch" href="/notes/assets/js/25.73c35036.js"><link rel="prefetch" href="/notes/assets/js/26.26a17ea1.js"><link rel="prefetch" href="/notes/assets/js/27.ff54efc7.js"><link rel="prefetch" href="/notes/assets/js/28.7a576fdd.js"><link rel="prefetch" href="/notes/assets/js/29.65ca74b8.js"><link rel="prefetch" href="/notes/assets/js/3.a1de041d.js"><link rel="prefetch" href="/notes/assets/js/30.b235ba0b.js"><link rel="prefetch" href="/notes/assets/js/31.f5d35d2f.js"><link rel="prefetch" href="/notes/assets/js/32.5fb01c4e.js"><link rel="prefetch" href="/notes/assets/js/33.27a6084d.js"><link rel="prefetch" href="/notes/assets/js/34.e34499cd.js"><link rel="prefetch" href="/notes/assets/js/35.e05f73d8.js"><link rel="prefetch" href="/notes/assets/js/36.60547d3a.js"><link rel="prefetch" href="/notes/assets/js/37.8738ec2c.js"><link rel="prefetch" href="/notes/assets/js/38.0f9fc7ec.js"><link rel="prefetch" href="/notes/assets/js/39.e8e18304.js"><link rel="prefetch" href="/notes/assets/js/4.4d64059e.js"><link rel="prefetch" href="/notes/assets/js/40.5b659f7e.js"><link rel="prefetch" href="/notes/assets/js/41.1ff90d94.js"><link rel="prefetch" href="/notes/assets/js/42.8019ce19.js"><link rel="prefetch" href="/notes/assets/js/43.dcf831a9.js"><link rel="prefetch" href="/notes/assets/js/44.2212c2b1.js"><link rel="prefetch" href="/notes/assets/js/45.0d98edcd.js"><link rel="prefetch" href="/notes/assets/js/46.98067727.js"><link rel="prefetch" href="/notes/assets/js/47.b2005f9a.js"><link rel="prefetch" href="/notes/assets/js/48.a256140a.js"><link rel="prefetch" href="/notes/assets/js/49.9c203339.js"><link rel="prefetch" href="/notes/assets/js/5.cb5d5a29.js"><link rel="prefetch" href="/notes/assets/js/50.159d1224.js"><link rel="prefetch" href="/notes/assets/js/51.97faa34e.js"><link rel="prefetch" href="/notes/assets/js/52.e1eeffc2.js"><link rel="prefetch" href="/notes/assets/js/53.2a1a2c71.js"><link rel="prefetch" href="/notes/assets/js/54.a0158ce8.js"><link rel="prefetch" href="/notes/assets/js/55.a625907e.js"><link rel="prefetch" href="/notes/assets/js/56.78907349.js"><link rel="prefetch" href="/notes/assets/js/57.c28a75b2.js"><link rel="prefetch" href="/notes/assets/js/58.2090981d.js"><link rel="prefetch" href="/notes/assets/js/59.c1ff87ad.js"><link rel="prefetch" href="/notes/assets/js/6.ca6dafd7.js"><link rel="prefetch" href="/notes/assets/js/60.ae25edf6.js"><link rel="prefetch" href="/notes/assets/js/61.3831ef0a.js"><link rel="prefetch" href="/notes/assets/js/62.c6a29d99.js"><link rel="prefetch" href="/notes/assets/js/63.986e9a2e.js"><link rel="prefetch" href="/notes/assets/js/64.63d581af.js"><link rel="prefetch" href="/notes/assets/js/65.27684864.js"><link rel="prefetch" href="/notes/assets/js/66.a6d2bda2.js"><link rel="prefetch" href="/notes/assets/js/67.1ad8f41a.js"><link rel="prefetch" href="/notes/assets/js/68.39074afa.js"><link rel="prefetch" href="/notes/assets/js/69.25ed532b.js"><link rel="prefetch" href="/notes/assets/js/7.2720f564.js"><link rel="prefetch" href="/notes/assets/js/70.44df2e14.js"><link rel="prefetch" href="/notes/assets/js/71.34ba6e79.js"><link rel="prefetch" href="/notes/assets/js/72.cf987fd2.js"><link rel="prefetch" href="/notes/assets/js/73.673a9c54.js"><link rel="prefetch" href="/notes/assets/js/74.4434c1e1.js"><link rel="prefetch" href="/notes/assets/js/75.de3c7c62.js"><link rel="prefetch" href="/notes/assets/js/8.9c587d73.js"><link rel="prefetch" href="/notes/assets/js/9.2e4520be.js">
    <link rel="stylesheet" href="/notes/assets/css/0.styles.42e4205b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/notes/" class="home-link router-link-active"><!----> <span class="site-name">相得益张</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/notes/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/blog/node/1 Node.js基础-环境安全配置.html" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/node-advanced/1 浅谈Node模块机制及常见面试问题解答.html" class="nav-link">
  Node进阶
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/koa/1 Node.js-Web开发-supervisor &amp; nodemon.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/nginx/1 Nginx 环境搭建.html" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/egg/1 egg.js介绍和环境搭建.html" class="nav-link">
  Egg
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/ts/1 基础类型.html" class="nav-link">
  TS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="题目" class="dropdown-title"><span class="title">题目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/questions/js/1 手写new的过程.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/http/1 什么是浏览器缓存机制.html" class="nav-link">
  HTTP
</a></li></ul></div></div> <a href="https://github.com/" target="_blank" rel="noopener noreferrer" class="repo-link">
    My GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/notes/" class="nav-link">
  主页
</a></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="笔记" class="dropdown-title"><span class="title">笔记</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/blog/node/1 Node.js基础-环境安全配置.html" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/node-advanced/1 浅谈Node模块机制及常见面试问题解答.html" class="nav-link">
  Node进阶
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/koa/1 Node.js-Web开发-supervisor &amp; nodemon.html" class="nav-link">
  Koa
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/nginx/1 Nginx 环境搭建.html" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/egg/1 egg.js介绍和环境搭建.html" class="nav-link">
  Egg
</a></li><li class="dropdown-item"><!----> <a href="/notes/blog/ts/1 基础类型.html" class="nav-link">
  TS
</a></li></ul></div></div><div class="nav-item"><div class="dropdown-wrapper"><button type="button" aria-label="题目" class="dropdown-title"><span class="title">题目</span> <span class="arrow right"></span></button> <ul class="nav-dropdown" style="display:none;"><li class="dropdown-item"><!----> <a href="/notes/questions/js/1 手写new的过程.html" class="nav-link">
  JS
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/vue/" class="nav-link">
  Vue
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/node/" class="nav-link">
  Node
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/nginx/" class="nav-link">
  Nginx
</a></li><li class="dropdown-item"><!----> <a href="/notes/questions/http/1 什么是浏览器缓存机制.html" class="nav-link">
  HTTP
</a></li></ul></div></div> <a href="https://github.com/" target="_blank" rel="noopener noreferrer" class="repo-link">
    My GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><a href="/notes/blog/egg/1 egg.js介绍和环境搭建.html" class="sidebar-link">egg.js 介绍和环境搭建</a></li><li><a href="/notes/blog/egg/2 egg.js 目录结构.html" class="sidebar-link">egg目录结构</a></li><li><a href="/notes/blog/egg/3 路由Router.html" class="sidebar-link">路由Router</a></li><li><a href="/notes/blog/egg/4 控制器Controller.html" class="active sidebar-link">控制器Controller</a></li><li><a href="/notes/blog/egg/5 服务Service.html" class="sidebar-link">服务 Service</a></li><li><a href="/notes/blog/egg/6 插件.html" class="sidebar-link">插件</a></li><li><a href="/notes/blog/egg/7 定时任务.html" class="sidebar-link">定时任务</a></li><li><a href="/notes/blog/egg/8 扩展.html" class="sidebar-link">扩展</a></li><li><a href="/notes/blog/egg/9 自定义启动项.html" class="sidebar-link">自定义启动项</a></li><li><a href="/notes/blog/egg/10 egg-mongoose.html" class="sidebar-link">Mongoose</a></li><li><a href="/notes/blog/egg/11 egg-cors.html" class="sidebar-link">egg-cors 跨域设置</a></li><li><a href="/notes/blog/egg/12 egg-jwt.html" class="sidebar-link">egg-jwt</a></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="控制器controller"><a href="#控制器controller" class="header-anchor">#</a> 控制器Controller</h1> <ol><li>controller 是在app 目录下的文件夹，<strong>解析用户的输入，处理后返回相应的结果</strong></li></ol> <ul><li>在app 目录下创建一个controller 文件夹</li> <li>在controller 文件夹下创建一个 js</li></ul> <ol start="2"><li>过程</li></ol> <ul><li>获取用户通过 HTTP 传递过来的请求参数。</li> <li>校验、组装参数。</li> <li>调用 Service 进行业务处理，必要时处理转换 Service 的返回结果，让它适应用户的需求。</li> <li>通过 HTTP 将结果响应给用户。</li></ul> <div class="language-javascript extra-class"><pre class="language-javascript"><code># 文件内部代码结构

<span class="token string">'use strict'</span>  
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;egg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>


# 这里<span class="token keyword">class</span>的命名与此时文件的名称要一致，文件的名字为main<span class="token punctuation">.</span>js  则<span class="token keyword">class</span>  为 MainController

<span class="token keyword">class</span> <span class="token class-name">MainController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    aysnc <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token comment">/**
         * @ctx 当前请求的上下文context 对象，跟koa中的是一样的，接口的参数，返回都可以从上面获取
         * @app 当前应用 Application 对象的实例，我们可以拿到所有的全局方法和对象
         * @service 定义好的service 层的数据，一般业务层的处理都在service, 这里我们就可以拿到service定义好得方法 等价于 this.ctx.service
         * @config 应用时的配置项基本上就是，config.default.js  config.xxxhuanjing.js 结合起来的属性
         * @logger logger 对象 有四个属性 debug, info, warn, error 四种不同的日志， 生成的日志会自动加上打印文件所在的路径
         */</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">,</span> app<span class="token punctuation">,</span> service<span class="token punctuation">,</span> config<span class="token punctuation">,</span> logger <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        
        # 可以这样引用service 或者model 文件夹下的js中的方法
        <span class="token keyword">const</span> res <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>main<span class="token punctuation">.</span><span class="token function">getList</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>  <span class="token comment">// 引用service 文件夹下 main.js 中的getList方法</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> res<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

module<span class="token punctuation">.</span>exports <span class="token operator">=</span> MainController<span class="token punctuation">;</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code># 表单的校验
<span class="token string">'use strict'</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>

<span class="token comment">// 先设置表单</span>
<span class="token keyword">const</span> createRule <span class="token operator">=</span> <span class="token punctuation">{</span>
    username<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">'email'</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    password<span class="token operator">:</span> <span class="token punctuation">{</span>
        type<span class="token operator">:</span> <span class="token string">&quot;password&quot;</span><span class="token punctuation">,</span>
        compare<span class="token operator">:</span> <span class="token string">'re-password'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
<span class="token keyword">class</span> <span class="token class-name">MainController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span><span class="token function">validte</span><span class="token punctuation">(</span>createRule<span class="token punctuation">)</span><span class="token punctuation">;</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> ctx<span class="token punctuation">.</span>request<span class="token punctuation">.</span>body<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code># app 下的 router<span class="token punctuation">.</span>js 如果使用定义好的controller中的方法呢？？

<span class="token string">'use strict'</span>

<span class="token comment">/**
 * @[Egg.Application] app =&gt;  其实这个是个全局应用对象，在每个对象只会实例化一次，默认已经把控制器和路由已经实例化好了，所以我们在这里就可以访问了
 */</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
    
    <span class="token comment">// 这样就是引用controller 文件夹下 main.js 的login 方法</span>
    router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>main<span class="token punctuation">.</span>login<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code># cookie 如何配置
  
<span class="token string">'use strict'</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;egg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MainController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span>  <span class="token function">index</span> <span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token comment">// 获取cookie</span>
        ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">'name'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        
        <span class="token comment">// 设置cookies</span>
        ctx<span class="token punctuation">.</span>cookies<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span><span class="token string">&quot;name&quot;</span><span class="token punctuation">,</span> <span class="token string">&quot;xxxx&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>


# 如果需要额外的配置 需要在config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js 里面进行配置
module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
    cookies<span class="token operator">:</span> <span class="token punctuation">{</span>
        httpOnly<span class="token operator">:</span> <span class="token boolean">false</span> <span class="token operator">|</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
        sameSite<span class="token operator">:</span> <span class="token string">'none|lax|strict'</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code># session 配置
<span class="token string">'use strict'</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// 获取session</span>
    <span class="token keyword">const</span> userId <span class="token operator">=</span> ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>userId<span class="token punctuation">;</span>

    <span class="token comment">// 设置session</span>
    ctx<span class="token punctuation">.</span>session<span class="token punctuation">.</span>name <span class="token operator">=</span> <span class="token string">&quot;fasdfa&quot;</span>
<span class="token punctuation">}</span>


<span class="token comment">//  有几个参数可以再config.default.js中进行配置</span>
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      key<span class="token operator">:</span> <span class="token string">'Egg_sess'</span><span class="token punctuation">,</span>
      maxAge<span class="token operator">:</span> <span class="token number">86400000</span>
  <span class="token punctuation">}</span>
</code></pre></div><div class="language-javascript extra-class"><pre class="language-javascript"><code># validate参数校验
<span class="token number">1.</span> 需要下载egg<span class="token operator">-</span>validate插件
            npm install egg<span class="token operator">-</span>validate <span class="token operator">--</span>save

<span class="token number">2.</span> 在plugin<span class="token punctuation">.</span>js 中去配置插件，启动插件
  module<span class="token punctuation">.</span>exports <span class="token operator">=</span> <span class="token punctuation">{</span>
      validate<span class="token operator">:</span> <span class="token punctuation">{</span>
          enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
          <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-validate'</span>
      <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>

<span class="token number">3.</span> 使用ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span><span class="token punctuation">[</span>body<span class="token punctuation">]</span><span class="token punctuation">)</span> 来进行参数校验
  <span class="token string">'use strict'</span>
  <span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
  <span class="token keyword">class</span> <span class="token class-name">MainController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
      ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">'string'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          content<span class="token operator">:</span> <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">'string'</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>

   # 校验的异常 会抛出<span class="token number">422</span> 这个错误 如果需要自己定义错误，那就需要<span class="token keyword">try</span> catch 去捕获错误了
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
          title<span class="token operator">:</span> <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">'string'</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>
          content<span class="token operator">:</span> <span class="token punctuation">{</span>
              type<span class="token operator">:</span> <span class="token string">'string'</span>
          <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">{</span>
        ctx<span class="token punctuation">.</span>logger<span class="token punctuation">.</span><span class="token function">warn</span><span class="token punctuation">(</span>err<span class="token punctuation">.</span>errors<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 然后自定义接口返回就可以了</span>
        ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> <span class="token string">'出错'</span>；
        <span class="token keyword">return</span> 
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  
  
<span class="token number">4.</span> 自定义校验规则

<span class="token comment">// app.js</span>
app<span class="token punctuation">.</span>validator<span class="token punctuation">.</span><span class="token function">addRule</span><span class="token punctuation">(</span><span class="token string">'json'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token parameter">rule<span class="token punctuation">,</span> value</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>value<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token string">'must be json string'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token keyword">class</span> <span class="token class-name">PostController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
  <span class="token keyword">async</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx<span class="token punctuation">}</span>  <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token comment">// query.test 字段必须是 json 字符串</span>
    <span class="token keyword">const</span> rule <span class="token operator">=</span> <span class="token punctuation">{</span> test<span class="token operator">:</span> <span class="token string">'json'</span> <span class="token punctuation">}</span><span class="token punctuation">;</span>
    ctx<span class="token punctuation">.</span><span class="token function">validate</span><span class="token punctuation">(</span>rule<span class="token punctuation">,</span> ctx<span class="token punctuation">.</span>query<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">;</span>



<span class="token number">5.</span> 调用service
       如果所有的业务逻辑都放置到controller 里面，就回导致controller里面特别的臃肿，所以， 我们可以将一部分业务逻辑放置到service里面
   可以提高代码的复用性。
       service 是懒加载的，所以需要使用<span class="token keyword">await</span> 去调用
    <span class="token string">'use strict'</span>
    <span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'egg'</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
    <span class="token keyword">class</span> <span class="token class-name">HomeController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
         <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
             <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
             <span class="token keyword">const</span> body <span class="token operator">=</span> <span class="token keyword">await</span> ctx<span class="token punctuation">.</span>service<span class="token punctuation">.</span>post<span class="token punctuation">.</span>getlist<span class="token punctuation">;</span>  <span class="token comment">// 获取service文件夹下 post.js中的getlist方法</span>
             ctx<span class="token punctuation">.</span>body <span class="token operator">=</span> body<span class="token punctuation">;</span>
         <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>


<span class="token number">6.</span> 使用模板 例如ejs
    
   <span class="token comment">// 使用ejs时 需要先安装 然后 引入ejs 插件</span>
    npm install egg<span class="token operator">-</span>view<span class="token operator">-</span>ejs <span class="token operator">--</span>save
    
    <span class="token comment">// plugin.js 引入这个插件</span>
     ejs<span class="token operator">:</span> <span class="token punctuation">{</span>
         enable<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>
         <span class="token keyword">package</span><span class="token operator">:</span> <span class="token string">'egg-view-ejs'</span>
     <span class="token punctuation">}</span>
    
    <span class="token comment">// 然后去config.default.js 中配置对应的后缀文件</span>

    config<span class="token punctuation">.</span>view <span class="token operator">=</span> <span class="token punctuation">{</span>
        mapping<span class="token operator">:</span> <span class="token punctuation">{</span>
            <span class="token string">'.html'</span><span class="token operator">:</span> <span class="token string">'ejs'</span>   <span class="token comment">// 意思就是说 views 下面的.html 文件 当做是ejs 的模板</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

 <span class="token comment">// 然后在对应的view 下面写入.html文件  </span>

<span class="token comment">// 最后就是在controller 中把文件渲染出去就可以了</span>
<span class="token string">'use strict'</span>
<span class="token keyword">const</span> Controller <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">&quot;egg&quot;</span><span class="token punctuation">)</span><span class="token punctuation">.</span>Controller<span class="token punctuation">;</span>
<span class="token keyword">class</span> <span class="token class-name">MainController</span> <span class="token keyword">extends</span> <span class="token class-name">Controller</span> <span class="token punctuation">{</span>
    <span class="token keyword">async</span> <span class="token function">index</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
        <span class="token keyword">const</span> <span class="token punctuation">{</span> ctx <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token comment">//读取文件，渲染文件</span>
        <span class="token keyword">await</span> ctx<span class="token punctuation">.</span><span class="token function">render</span><span class="token punctuation">(</span><span class="token string">'index.html'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>



<span class="token number">7.</span> 跨域  除了设置cors 之外  egg 提供了 <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">)</span> 方法来实现跨域访问，自带<span class="token constant">XSS</span>防御
  # 当用户在请求这个接口的时候，必须带上_callback 这个参数  值为一个不大于<span class="token number">50</span>长度的字符串  不然会返回json格式的数据
   <span class="token comment">// router.js</span>
  module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> jsonp<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
      <span class="token keyword">const</span> jsonp <span class="token operator">=</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> jsonp<span class="token punctuation">,</span> controller<span class="token punctuation">.</span>main<span class="token punctuation">.</span>getlist<span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  
 方法<span class="token number">1</span> <span class="token comment">// 如果希望用别的字段 也是可以的 但是需要去全局重新去配置 config.default.js</span>
     config<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
         callback<span class="token operator">:</span> <span class="token string">&quot;callback&quot;</span><span class="token punctuation">,</span>   <span class="token comment">//设置好的字段</span>
         limit<span class="token operator">:</span> <span class="token number">100</span>  <span class="token comment">// 最大为100</span>
     <span class="token punctuation">}</span>
  

方法<span class="token number">2</span>： 在路由界面中进行配置覆盖
  
   module<span class="token punctuation">.</span><span class="token function-variable function">exports</span> <span class="token operator">=</span> <span class="token parameter">app</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> <span class="token punctuation">{</span> router<span class="token punctuation">,</span> jsonp<span class="token punctuation">,</span> controller <span class="token punctuation">}</span> <span class="token operator">=</span> app<span class="token punctuation">;</span>
      <span class="token keyword">const</span> jsonp <span class="token operator">=</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/&quot;</span><span class="token punctuation">,</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>callback<span class="token operator">:</span> <span class="token string">'callback'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>main<span class="token punctuation">.</span>getlist<span class="token punctuation">)</span><span class="token punctuation">;</span>
      router<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token string">&quot;/login&quot;</span><span class="token punctuation">,</span> <span class="token function">jsonp</span><span class="token punctuation">(</span><span class="token punctuation">{</span>callback<span class="token operator">:</span> <span class="token string">'bv'</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">,</span> controller<span class="token punctuation">.</span>main<span class="token punctuation">.</span>login<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
   
   
   # 默认情况下， jsonp 是不会对csrf 攻击进行防范的，这个就需要我们自己去配置 config<span class="token punctuation">.</span>default<span class="token punctuation">.</span>js
    config<span class="token punctuation">.</span>jsonp <span class="token operator">=</span> <span class="token punctuation">{</span>
        callback<span class="token operator">:</span> <span class="token string">'callback'</span><span class="token punctuation">,</span>
        csrf<span class="token operator">:</span> <span class="token boolean">true</span><span class="token punctuation">,</span>  <span class="token comment">//  因为默认是开启xss防御的  csrf防御需要这样手动的去开启</span>
        limit<span class="token operator">:</span> <span class="token number">100</span><span class="token punctuation">,</span>
        
        # 可以设置jsonp的访问地址的白名单，可以使字符串， 数组，或者正则表达式
        whiteList<span class="token operator">:</span> <span class="token punctuation">[</span> <span class="token string">'.com'</span><span class="token punctuation">,</span> <span class="token string">'.cm'</span> <span class="token punctuation">]</span><span class="token punctuation">,</span>  
        whiteList<span class="token operator">:</span> <span class="token string">'.com'</span><span class="token punctuation">,</span>
        whiteList<span class="token operator">:</span> <span class="token regex">/^https?:\/\/test.com\//</span><span class="token punctuation">,</span>
    <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/notes/blog/egg/3 路由Router.html" class="prev">
        路由Router
      </a></span> <span class="next"><a href="/notes/blog/egg/5 服务Service.html">
        服务 Service
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/notes/assets/js/app.21629e5a.js" defer></script><script src="/notes/assets/js/2.270ffd18.js" defer></script><script src="/notes/assets/js/12.34958283.js" defer></script>
  </body>
</html>
